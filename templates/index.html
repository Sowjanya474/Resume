<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resume Ranker</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f7f8;
      --card:#ffffff;
      --muted:#6c757d;
      --accent:#1f2b47;
      --soft:#eef3fb;
    }

    body{
      background:var(--bg);
      font-family: Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0;
      padding:36px 20px;
    }

    .brand { text-align:center; margin-bottom:28px; }
    .brand h1{ margin:0; font-size:42px; color:var(--accent); font-weight:800; }
    .brand p { margin:8px 0 0; color:#6b7280; font-size:16px; }

    .panel {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 24px;
      align-items: start;
      max-width: 1200px;
      margin: 0 auto;
    }
    @media (max-width: 980px){
      .panel { grid-template-columns: 1fr; }
      .right-card { order: 3; }
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 6px 22px rgba(17,24,39,0.06);
      border:0;
    }

    /* upload box */
    .upload-box {
      border:2px dashed #d9e1ef;
      border-radius:10px;
      padding:18px;
      text-align:center;
      background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(250,251,255,0.6));
      cursor:pointer;
      transition:background .15s, border-color .15s;
      min-height:140px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:12px;
      position:relative;
      overflow:hidden;
    }
    .upload-box.dragover { background:var(--soft); border-color:#a8c0ef; }

    .upload-top {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      color:var(--muted);
    }
    .upload-top .icon { font-size:34px; color:#8b96a8; }

    /* chips inside drop zone */
    .chips {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      padding:6px 12px;
      max-height:70px;
      overflow:auto;
    }
    .chip {
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#f1f5f9;
      color:#1f2937;
      padding:6px 10px;
      border-radius:999px;
      font-size:13px;
      box-shadow:0 1px 0 rgba(0,0,0,0.02);
    }
    .chip .remove {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border-radius:50%;
      background:transparent;
      border:0;
      color:#6b7280;
      cursor:pointer;
      font-weight:700;
      line-height:1;
    }
    .chip .remove:hover { color:#111827; }

    .small-muted { color:var(--muted); font-size:13px; margin-top:8px; }

    .results-empty {
      display:flex;
      height:420px;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      color:#9aa3b3;
      text-align:center;
      gap:10px;
    }
    .results-empty .doc-icon {
      width:64px; height:64px; border-radius:8px; border:2px solid #e6e9ee;
      display:flex; align-items:center; justify-content:center; font-size:28px; color:#b8c1cf; background:white;
    }

    .resume-card { margin-bottom:14px; padding:14px; border-radius:10px; border:1px solid #eef2f6; }
    .score { font-weight:800; padding:8px 14px; border-radius:10px; min-width:88px; text-align:center; display:inline-block; }
    .score.high { background:#d4f7d2; color:#1c6a2f; }
    .score.med  { background:#fff3cc; color:#7a5f04; }
    .score.low  { background:#ffdede; color:#8a2525; }

    .tag { display:inline-block; padding:4px 10px; border-radius:999px; background:#f1f5f9; margin-right:6px; margin-top:6px; font-size:13px; color:#374151; }
    .tag.missing { background:#fff4e6; color:#7a4a00; }

    .btn-primary.wide { width:100%; padding:10px 14px; font-weight:700; border-radius:8px; }
    .footer-note { font-size:13px; color:#7b8794; margin-top:10px; }

    .left-column { display:flex; flex-direction:column; gap:24px; }
    .right-card { height:100%; display:flex; flex-direction:column; }
  </style>
</head>
<body>

  <div class="brand">
    <h1>Resume Ranker</h1>
    <p>Resume Ranking based on job descriptions</p>
  </div>

  <div class="panel">
    <!-- left column (single grid item with stacked cards) -->
    <div class="left-column">
      <div class="card">
        <h5 class="mb-3">Upload Resumes</h5>

        <div id="dropzone" class="upload-box" tabindex="0" aria-label="Upload resumes. Click or drag files here.">
          <div class="upload-top">
            <div class="icon">‚òÅÔ∏è</div>
            <div>
              <div style="font-weight:700;">Drag and drop your resume files here, or click to select files</div>
              <div class="small-muted">Supports PDF, DOC, DOCX, TXT (Max 10MB per file)</div>
            </div>
          </div>

          <!-- chips container holds uploaded filenames -->
          <div id="chips" class="chips" aria-live="polite"></div>

          <input id="fileInput" type="file" multiple accept=".pdf,.doc,.docx,.txt" style="display:none" />
        </div>
      </div>

      <div class="card">
        <h5 class="mb-3">Job Description</h5>
        <textarea id="jd" class="form-control mb-2" rows="6" placeholder="Paste the job description here..."></textarea>
        <div class="d-flex gap-2 mt-2">
          <button id="rankBtn" class="btn btn-primary wide">Rank Resumes</button>
        </div>
       
      </div>
    </div>

    <!-- right column -->
    <div class="card right-card" id="resultsCard" style="min-height:520px; display:flex; flex-direction:column;">
      <h5 class="mb-3">Ranking Results</h5>
      <div id="resultsBody" style="flex:1; display:flex; align-items:center; justify-content:center;">
        <div class="results-empty" id="emptyState">
          <div class="doc-icon">üìÑ</div>
          <div style="font-weight:600;">No results yet</div>
          <div class="small-muted" style="max-width:260px;">Upload resumes and analyze them based on job description to see results.</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Elements
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const chipsEl = document.getElementById('chips');
  const rankBtn = document.getElementById('rankBtn');
  const resultsBody = document.getElementById('resultsBody');
  const emptyState = document.getElementById('emptyState');
  const jdEl = document.getElementById('jd');

  // store files in a Map to allow removal by key (name+size)
  const filesMap = new Map();

  // helper: unique id for a file
  function fileKey(file){ return `${file.name}::${file.size}::${file.lastModified}`; }

  // show file picker
  dropzone.addEventListener('click', () => fileInput.click());
  dropzone.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') fileInput.click(); });

  // file input change
  fileInput.addEventListener('change', (ev) => {
    const incoming = Array.from(ev.target.files || []);
    addFiles(incoming);
    fileInput.value = ''; // clear to allow same-file reselect
  });

  // drag events
  ['dragenter','dragover'].forEach(name => {
    dropzone.addEventListener(name, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover'); }, false);
  });
  ['dragleave','drop'].forEach(name => {
    dropzone.addEventListener(name, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover'); }, false);
  });
  dropzone.addEventListener('drop', (e) => {
    const dt = e.dataTransfer;
    if(!dt) return;
    const dropped = Array.from(dt.files || []);
    addFiles(dropped);
  });

  function addFiles(list){
    list.forEach(f => {
      // simple validation: file type and size (10MB)
      const max = 10 * 1024 * 1024;
      if(f.size > max) {
        alert(`"${f.name}" exceeds 10MB and was skipped.`);
        return;
      }
      const key = fileKey(f);
      if(!filesMap.has(key)) filesMap.set(key, f);
    });
    renderChips();
  }

  function removeFileByKey(key){
    filesMap.delete(key);
    renderChips();
  }

  function renderChips(){
    chipsEl.innerHTML = '';
    if(filesMap.size === 0){
      // keep chips empty (dropbox already shows instruction)
      return;
    }

    // build chip for each file
    filesMap.forEach((file, key) => {
      const chip = document.createElement('div');
      chip.className = 'chip';
      const shortName = file.name.length > 28 ? file.name.slice(0,24) + '‚Ä¶' : file.name;
      chip.innerHTML = `
        <span title="${escapeHtml(file.name)}">${escapeHtml(shortName)}</span>
        <button type="button" class="remove" aria-label="Remove ${escapeHtml(file.name)}">&times;</button>
      `;
      const btn = chip.querySelector('.remove');
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        removeFileByKey(key);
      });
      chipsEl.appendChild(chip);
    });
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

  // Clear results area helper
  function clearResults(){
    resultsBody.innerHTML = '';
    resultsBody.appendChild(emptyState);
  }

  // render result card (same as before)
  function renderResult(r){
    if (emptyState && emptyState.parentNode) emptyState.parentNode.removeChild(emptyState);

    const wrapper = document.createElement('div');
    wrapper.className = 'resume-card';

    let scoreClass = 'low';
    if(r.match >= 75) scoreClass = 'high';
    else if(r.match >= 50) scoreClass = 'med';

    wrapper.innerHTML = `
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div style="font-size:16px; font-weight:700; color:#0f1724">${escapeHtml(r.name)}</div>
          <div style="margin-top:6px;">
            <span style="display:inline-block; background:#1768e8; color:white; padding:6px 10px; border-radius:6px; font-weight:600; font-size:12px;">${escapeHtml(r.tier || 'Unranked')}</span>
            <span style="color:#6b7280; font-size:13px; margin-left:8px">Global Standing: <strong>${escapeHtml(r.global || 'N/A')}</strong></span>
          </div>
        </div>
        <div class="text-center">
          <div class="score ${scoreClass}">${r.match}% Match</div>
        </div>
      </div>

      <hr style="margin:12px 0; border-color:#eef2f6">

      <div style="font-size:14px; color:#334155; margin-bottom:8px"><strong>Summary</strong>
        <div style="color:#6b7280; margin-top:6px;">${escapeHtml(r.summary)}</div>
      </div>

      <div><strong>Missing Critical Skills</strong>
        <div style="margin-top:8px">${r.missing && r.missing.length ? r.missing.map(k => `<span class="tag missing">${escapeHtml(k)}</span>`).join('') : '<span style="color:#16a34a; font-weight:600">None detected</span>'}</div>
      </div>
    `;

    resultsBody.appendChild(wrapper);
  }

  // Rank Resumes -> POST to /analyze (multipart)
  rankBtn.addEventListener('click', async () => {
    if(filesMap.size === 0){
      alert('Select or drop at least one resume before ranking.');
      return;
    }
    if(!jdEl.value.trim()){
      if(!confirm('No job description provided. Continue?')) return;
    }

    // spinner
    resultsBody.innerHTML = '';
    const spinnerWrap = document.createElement('div');
    spinnerWrap.style.width = '100%';
    spinnerWrap.style.display = 'flex';
    spinnerWrap.style.justifyContent = 'center';
    spinnerWrap.style.alignItems = 'center';
    spinnerWrap.style.flexDirection = 'column';
    spinnerWrap.style.gap = '10px';
    spinnerWrap.innerHTML = `<div class="spinner-border" role="status"></div><div style="color:#6b7280">Sending files for AI analysis...</div>`;
    resultsBody.appendChild(spinnerWrap);

    const fd = new FormData();
    fd.append('jd', jdEl.value);

    // append files in insertion order
    for(const f of filesMap.values()){
      fd.append('resumes', f, f.name);
    }

    try {
      const resp = await fetch('/analyze', { method:'POST', body: fd });
      if(!resp.ok) throw new Error('Server returned ' + resp.status);
      const data = await resp.json();

      resultsBody.innerHTML = '';
      if(data && Array.isArray(data.results) && data.results.length){
        data.results.forEach(r => {
          renderResult({
            name: r.Name || r.filename || 'Candidate',
            match: Number(r.MatchPercentage || r.match || 0),
            tier: r.MarketTier || r.Tier,
            global: r.GlobalMatch || r.GlobalRank,
            summary: r.Summary || r.summary || 'No summary available',
            missing: r.MissingKeywords || r.missing || []
          });
        });
      } else {
        resultsBody.innerHTML = `
          <div class="results-empty">
            <div class="doc-icon">‚ö†Ô∏è</div>
            <div style="font-weight:600">No results returned</div>
            <div class="small-muted">The server processed the request but returned no parsed results.</div>
          </div>`;
      }
    } catch (err) {
      resultsBody.innerHTML = `
        <div class="results-empty">
          <div class="doc-icon">‚ùå</div>
          <div style="font-weight:600">Client/Server error</div>
          <div class="small-muted" style="max-width:320px">Could not reach /analyze endpoint. ${escapeHtml(err.message || '')}</div>
        </div>
      `;
    }
  });

  // initial
  clearResults();
</script>

</body>
</html>